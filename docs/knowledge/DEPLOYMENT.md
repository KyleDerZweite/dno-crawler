# Deployment

Production deployment uses `docker-compose.prod.yml` with `podman-compose` on a rootless Podman host. Pangolin handles TLS termination and reverse proxying; Newt tunnels traffic from Pangolin to the local stack.

## Prerequisites

### 1. Podman short-name resolution

Rootless Podman on Ubuntu does not resolve unqualified image names by default. Without this, `postgres:16-alpine` fails to pull with:

```
short-name "postgres:16-alpine" did not resolve to an alias and no unqualified-search registries are defined
```

Fix (one-time, on the host):

```bash
sudo sh -c 'echo unqualified-search-registries=["docker.io"] >> /etc/containers/registries.conf'
```

Verify:

```bash
grep "unqualified-search" /etc/containers/registries.conf
# Expected: unqualified-search-registries=["docker.io"]
```

### 2. Seed parquet file

`data/seed-data/dnos_enriched_with_stats.parquet` must exist before starting. It is tracked in git. If missing, regenerate via stages 5+6 in `docs/knowledge/SEEDING.md`.

### 3. `.env` file

Copy from `.env.example` and fill in all values. See `.env.example` for field descriptions. Key production values:

| Variable | Notes |
|----------|-------|
| `POSTGRES_PASSWORD` | Strong random password |
| `USE_ALEMBIC_MIGRATIONS` | Must be `true` in production |
| `ENVIRONMENT` | Must be `production` |
| `ZITADEL_DOMAIN` | Your Zitadel instance domain |
| `ZITADEL_CLIENT_ID` | From Zitadel OIDC app |
| `VITE_ZITADEL_AUTHORITY` | `https://<ZITADEL_DOMAIN>` |
| `VITE_ZITADEL_REDIRECT_URI` | `https://<your-domain>/callback` |
| `CORS_ORIGINS` | `["https://<your-domain>"]` |
| `PANGOLIN_ENDPOINT` | Pangolin control plane URL |
| `NEWT_ID` / `NEWT_SECRET` | From Pangolin site config |
| `TRUSTED_PROXY_COUNT` | `2` (Pangolin + Newt) |

### 4. Pangolin site

Create a Pangolin site with two resources:
- `/api/*` → `backend:8000`
- `/*` → `frontend:80`

Create a Zitadel OIDC app with redirect URI `https://<your-domain>/callback`.

### 5. Data directories

Ensure data directories exist (they are created via `.gitkeep` files):

```bash
ls data/postgres data/redis data/downloads
```

If wiping for a fresh deploy, the directories must still exist (podman volume mounts require them):

```bash
mkdir -p data/postgres data/redis data/downloads
```

Note: `data/postgres` and `data/redis` are owned by root when created by a running container. Wiping them requires `sudo rm -rf data/postgres data/redis`.

## Deploy

```bash
podman-compose -f docker-compose.prod.yml up -d --build
```

### Startup order

1. `db` and `redis` start, pass healthchecks
2. `backend` entrypoint runs `alembic upgrade head` (creates/migrates all tables), then uvicorn starts
3. `worker-crawl` starts, calls `init_db()` with `USE_ALEMBIC_MIGRATIONS=false` (no-op since tables exist), then seeds DNOs from parquet
4. `worker-extract` starts, calls `init_db()` (no-op)
5. `frontend` builds and serves via nginx on port 80
6. `newt` connects to Pangolin and exposes the stack

### Verify startup

```bash
# All services running
podman-compose -f docker-compose.prod.yml ps

# Backend healthy and migrations applied
podman logs dno-crawler-backend-prod 2>&1 | grep -E "migration|initialized|Starting"

# Seeding complete
podman logs dno-crawler-worker-crawl-prod 2>&1 | grep -E "Seeding|inserted|updated"

# Frontend serving
curl -sf http://localhost:80 | head -5
```

## Alembic migrations

The initial migration (`backend/alembic/versions/`) was generated by:

1. Starting a fresh postgres via dev compose (which exposes port 5432 to the host)
2. Running `alembic revision --autogenerate -m "initial schema"` against the empty DB
3. Formatting the output with `uv tool run ruff format`

**Rootless Podman cannot reach container IPs from the host.** The prod compose does not expose db/redis ports. Always use the dev compose (`docker-compose.yml`) when running local alembic commands.

For future schema changes:

```bash
# Start dev db
podman-compose up -d db

# Generate migration
cd backend
DATABASE_URL="postgresql+asyncpg://<user>:<pass>@localhost:5432/dno_crawler" \
  uv run alembic revision --autogenerate -m "description"

# Format (ruff is not on PATH, use uv tool)
uv tool run ruff format alembic/versions/<rev>_description.py

# Stop dev db
podman-compose down
```

The `alembic.ini` post-write hook calls `ruff` as a bare executable which is not on PATH outside the venv. The hook fails but the file is generated. Always manually format with `uv tool run ruff format` after generation.

## Teardown / reset

```bash
# Stop all services
podman-compose -f docker-compose.prod.yml down

# Wipe persistent data (requires sudo -- podman rootless creates root-owned files)
sudo rm -rf data/postgres data/redis

# Recreate empty directories
mkdir -p data/postgres data/redis
```

## Troubleshooting

| Symptom | Cause | Fix |
|---------|-------|-----|
| `short-name did not resolve` on image pull | `unqualified-search-registries` not set | See Prerequisites §1 |
| Backend fails with `alembic upgrade head` error | No migration files in `alembic/versions/` | Generate initial migration (see above) |
| `alembic: not found` in entrypoint | Host `.venv` copied into image, overwriting container-built venv with host-path shebangs | Ensure `.venv/` is in `backend/.dockerignore`; remove cached images and rebuild |
| `alembic/versions/` excluded from image | `.dockerignore` blocked migration files | Remove `alembic/versions/` from `.dockerignore`; only exclude `.venv/` |
| `gin_trgm_ops does not exist` in migration | `pg_trgm` extension not created before migration runs | Add `op.execute("CREATE EXTENSION IF NOT EXISTS pg_trgm")` at top of `upgrade()` in initial migration |
| `relation already exists` during migration | Workers ran `create_all()` before backend finished `alembic upgrade head` | Workers must depend on `backend: service_healthy`; set `USE_ALEMBIC_MIGRATIONS=true` on workers so they skip `create_all()` |
| Frontend fails with `privileged port 80` | Rootless Podman cannot bind ports < 1024 | Remove host port binding from frontend -- Newt reaches `frontend:80` via internal network; no host binding needed |
| `dno.kylehub.dev` returns HTTP 526 | Pangolin site not yet configured | Create site + resources in Pangolin |
| Seeding skipped with "No seed data file found" | Parquet missing from `data/seed-data/` | Regenerate via SEEDING.md stages 5+6 |
| `ai_encryption_no_key` critical log on startup | `AI_ENCRYPTION_KEY` or `SESSION_SECRET` not set | Add either variable to `.env`; without it, AI provider credentials stored in DB are not encrypted |
